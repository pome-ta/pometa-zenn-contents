---
title: "ã€protocolã€‘objc_util ã‹ã‚‰rubicon-objc ã¸ç§»è¡Œã€delegateã€‘"
emoji: "ğŸ“²"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "iOS", "objectivec", "Pythonista3", "rubiconobjc"]
published: false
---
## objc_util ã‹ã‚‰rubicon-objc ã¸ä¹—ã‚Šæ›ãˆã‚‹

å‰å›ã¯ã€classå®£è¨€ã®æ–¹æ³•ã«ã¤ã„ã¦æ•´ç†ã—ãŸã€‚

@[card](https://zenn.dev/pometa/articles/7f70cc2fae9cb3)

rubicon-objcã¯objc_utilã‚ˆã‚Šã‚‚ã€Pythonã®æ–‡æ³•ã«æº–æ‹ ã—ãŸPythonicãªclasså®£è¨€ã€‚ã¤ã¾ã‚Šã€objc_utilã®`create_objc_class`ã«ä¾å­˜ã—ãŸæ›¸ãæ–¹ã¯ä¸è¦ã¨ãªã‚‹ã€‚

ä»Šå›ã¯ã€protocolï¼ˆdelegateï¼‰ã‚’ä¸­å¿ƒã«ã€ã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ›ãˆã®æ•´ç†ã™ã‚‹ã€‚

## ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™

ä½¿ã†å ´é¢ã¨ã—ã¦:

- ä»Šå›ä½¿ç”¨ã™ã‚‹ã‚‚ã®
  - [UINavigationControllerDelegate | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uinavigationcontrollerdelegate?language=objc)

- Pythonista3ã®docsã«ä¾‹ã¨ã—ã¦ã‚ã£ãŸã‚‚ã®
  - [UIGestureRecognizerDelegate | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uigesturerecognizerdelegate?language=objc)
  - [UITableViewDataSource | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uitableviewdatasource?language=objc)

Apple Developer Documentationã§`Protocol`ã¨è¡¨è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ä½¿ç”¨ã€‚
`UITableViewDataSource`ã®ã‚ˆã†ã«`Delegate`ãŒåå‰ã«å…¥ã£ã¦ã„ãªã„å ´åˆã‚‚ã‚ã‚‹ã€‚ã¾ãšã¯ã€ï¼ˆAppleï¼‰å…¬å¼Documentationã§èª¿ã¹ã‚‹ã“ã¨ãŒå¤§åˆ‡ã€‚

### objc_util ã®å ´åˆ

classã®å®£è¨€ã¨åŒæ§˜ã«ã€[create_objc_class](https://omz-software.com/pythonista/docs-3.4/py3/ios/objc_util.html#objc_util.create_objc_class)ã§å®£è¨€ã€‚

@[card](https://omz-software.com/pythonista/docs-3.4/py3/ios/objc_util.html#objc_util.create_objc_class)

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’å³è‚©ã«æŒãŸã›ãŸ[`UINavigationController`](https://developer.apple.com/documentation/uikit/uinavigationcontroller?language=objc)ã‚’å®Ÿè£…ã—ãŸä¾‹ï¼ˆä¸€éƒ¨ä¸­ç•¥ï¼‰ã€‚
`ui`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®[ui.NavigationView](https://omz-software.com/pythonista/docs-3.4/py3/ios/ui.html#ui.NavigationView)ã®ã‚ˆã†ãªã‚‚ã®ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã„ã‚‹(`ui`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã‚ãšã«ã€Pythonista3ä¸Šã§ç‹¬è‡ªã«UIKitã‚’å‘¼ã³å‡ºã™å ´é¢ã§ä½¿ç”¨)ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®šç¾©ã¨ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºswiftã€‚

:::message
ToDo: ã‚­ãƒ£ãƒ—ãƒãƒ£ã®Gifã‹é™æ­¢ç”»ã‚’è¼‰ã›ã¦è£œè¶³èª¬æ˜ã™ã‚‹äºˆå®šã€‚
:::

```python:objc_utilã®sample.py
UINavigationController = ObjCClass('UINavigationController')

class NavigationController:

  def __init__(self):
    self._navigationController: UINavigationController

  def _override_navigationController(self):
    # --- `UINavigationController` Methods
    def doneButtonTapped_(_self, _cmd, _sender):
      """ï¼ˆè‡ªèº«ã®ï¼‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
      `NavigationController` ã‹ã‚‰ç”Ÿã‚„ã—ãŸ`done_btn` ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      """
      this = ObjCInstance(_self)
      visibleViewController = this.visibleViewController()
      visibleViewController.dismissViewControllerAnimated_completion_(
        True, None)

    # --- `UINavigationController` set up
    _methods = [
      doneButtonTapped_,
    ]

    create_kwargs = {
      'name': '_nv',
      'superclass': UINavigationController,
      'methods': _methods,
    }
    _nv = create_objc_class(**create_kwargs)
    self._navigationController = _nv

  def create_navigationControllerDelegate(self):
    # --- `UINavigationControllerDelegate` Methods
    def navigationController_willShowViewController_animated_(
        _self, _cmd, _navigationController, _viewController, _animated):

      navigationController = ObjCInstance(_navigationController)
      viewController = ObjCInstance(_viewController)
      """
      é•·ã„ã®ã§ä¸­ç•¥
      """
      done_btn = UIBarButtonItem.alloc(
      ).initWithBarButtonSystemItem_target_action_(0, navigationController,
                                                   sel('doneButtonTapped:'))
      visibleViewController = navigationController.visibleViewController()
      # --- navigationItem
      navigationItem = visibleViewController.navigationItem()
      navigationItem.rightBarButtonItem = done_btn

    # --- `UINavigationControllerDelegate` set up
    _methods = [
      navigationController_willShowViewController_animated_,
    ]
    _protocols = [
      'UINavigationControllerDelegate',
    ]

    create_kwargs = {
      'name': '_nvDelegate',
      'methods': _methods,
      'protocols': _protocols,
    }
    _nvDelegate = create_objc_class(**create_kwargs)
    return _nvDelegate.new()

  @on_main_thread
  def _init(self, vc: UIViewController):
    self._override_navigationController()
    nv = self._navigationController.alloc()
    nv.initWithRootViewController_(vc).autorelease()
    _delegate = self.create_navigationControllerDelegate()
    nv.setDelegate_(_delegate)
    return nv

  @classmethod
  def new(cls, vc: UIViewController) -> ObjCInstance:
    _cls = cls()
    return _cls._init(vc)
```

#### è¾›ã„éƒ¨åˆ†

ã‚¯ãƒ©ã‚¹ã®ä¸‹éƒ¨ã«ã‚ã‚‹`_init` ãƒ¡ã‚½ãƒƒãƒ‰ã«æ³¨ç›®ã—ã¦ã¿ã‚‹ã€‚

- `UINavigationController` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆï¼ˆ`nv`ï¼‰
- `UINavigationControllerDelegate` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆï¼ˆ`_delegate`ï¼‰
- `nv.setDelegate_(_delegate)` ã§ç´ä»˜ã‘


`create_objc_class` ã«ã¦ã€`protocols` ã®å¼•æ•°ã«delegate ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã€‚`superclass` ã¨`protocols` ã‚’åŒæ™‚ã«å¼•æ•°ã‚’æ¸¡ã™äº‹ã‚‚å¯èƒ½ã§ã¯ã‚ã‚‹ï¼ˆå¤šåˆ†ï¼‰ã€‚

ã€Œå¤šåˆ†ã€ã¨ã—ãŸç†ç”±ãŒã€`create_objc_class` ã¯é–¢æ•°ã‚’å¼•æ•°`methods` ã¸æ¸¡ã™é–¢ä¿‚ä¸Šã€å„é–¢æ•°ãŒç‚¹åœ¨ã™ã‚‹æ‡¸å¿µãŒã‚ã‚‹ã€‚
äº‹ä¾‹ã‚³ãƒ¼ãƒ‰ã®æ‰‹æ³•ã¯ã€class ã§å›²ã†äº‹ã§ç‚¹åœ¨ã™ã‚‹ã®ã‚’å›é¿ã—ã¦ã„ã‚‹ãŒã€å·»ãä¸Šã’ï¼ˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã®ç‰¹æ€§ä¸Š`create_objc_class` ç”Ÿæˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä»¥å‰ã«


### rubicon-objc ã®å ´åˆ

## ãƒ¡ãƒ¢

blockã®ã“ã¨ã¯ã€audioã§ã‚„ã‚‹ã®ã§ã€delegateã™ã‚‹ãŸã‚ã«ã€protocolã‚’å‘¼ã³å‡ºã™æ„Ÿã˜ã§èª¬æ˜ã‚’ã—ã¦ã„ãã€‚

## code

```main.py
from rubicon.objc.api import ObjCClass, ObjCProtocol, objc_method
from rubicon.objc.runtime import SEL, send_super

import pdbr

ObjCClass.auto_rename = True

### --- onMainThread --- ###
from ctypes import byref, cast, Structure
import functools
from rubicon.objc.api import Block, ObjCClass, ObjCInstance
from rubicon.objc.runtime import libobjc, objc_block, objc_id

NSThread = ObjCClass('NSThread')


class struct_dispatch_queue_s(Structure):
  pass  # No _fields_, because this is an opaque structure.


_dispatch_main_q = struct_dispatch_queue_s.in_dll(libobjc, '_dispatch_main_q')


def dispatch_get_main_queue():
  return ObjCInstance(cast(byref(_dispatch_main_q), objc_id))


libobjc.dispatch_async.restype = None
libobjc.dispatch_async.argtypes = [objc_id, objc_block]


def onMainThread(func):

  @functools.wraps(func)
  def wrapper(*args, **kwargs):
    if NSThread.isMainThread:
      func(*args, **kwargs)
    block = Block(functools.partial(func, *args, **kwargs), None)
    libobjc.dispatch_async(dispatch_get_main_queue(), block)

  return wrapper


### --- ###

# --- UINavigationController
UINavigationController = ObjCClass('UINavigationController')
UINavigationControllerDelegate = ObjCProtocol('UINavigationControllerDelegate')
UINavigationBarAppearance = ObjCClass('UINavigationBarAppearance')
UIBarButtonItem = ObjCClass('UIBarButtonItem')

# --- UIViewController
UIViewController = ObjCClass('UIViewController')
UIColor = ObjCClass('UIColor')
UIButtonConfiguration = ObjCClass('UIButtonConfiguration')
UIButton = ObjCClass('UIButton')

NSLayoutConstraint = ObjCClass('NSLayoutConstraint')
# ref: [UIRectEdge | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uirectedge?language=objc)
'''
UIRectEdgeNone = 0
'''
edgeNone = 0

# ref: [UIControlEvents | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uicontrolevents?language=objc)
'''
UIControlEventTouchUpInside = 1 <<  6
'''
touchUpInside = 1 << 6

# ref: [UIBarButtonSystemItem | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uibarbuttonsystemitem?language=objc)
'''
UIBarButtonSystemItemDone
'''
done = 0


# --- NavigationController
class RootNavigationController(UINavigationController,
                               protocols=[UINavigationControllerDelegate]):

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    appearance = UINavigationBarAppearance.new()
    appearance.configureWithDefaultBackground()

    navigationBar = self.navigationBar
    navigationBar.standardAppearance = appearance
    navigationBar.scrollEdgeAppearance = appearance
    navigationBar.compactAppearance = appearance
    navigationBar.compactScrollEdgeAppearance = appearance

    self.delegate = self

  @objc_method
  def doneButtonTapped_(self, sender):
    visibleViewController = self.visibleViewController
    visibleViewController.dismissViewControllerAnimated_completion_(True, None)

  @objc_method
  def navigationController_willShowViewController_animated_(
      self, navigationController, viewController, animated: bool):
    viewController.setEdgesForExtendedLayout_(edgeNone)
    doneButton = UIBarButtonItem.alloc(
    ).initWithBarButtonSystemItem_target_action_(done, navigationController,
                                                 SEL('doneButtonTapped:'))
    visibleViewController = navigationController.visibleViewController

    navigationItem = visibleViewController.navigationItem
    navigationItem.rightBarButtonItem = doneButton


# --- ViewController
class FirstViewController(UIViewController):

  @objc_method
  def onTap_(self, sender):
    svc = SecondViewController.new()
    navigationController = self.navigationController
    navigationController.pushViewController_animated_(svc, True)

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    # --- Navigation
    self.navigationItem.title = 'FirstView'

    # --- View
    self.view.backgroundColor = UIColor.systemBlueColor()
    config = UIButtonConfiguration.tintedButtonConfiguration()
    config.title = 'Tap'
    config.baseBackgroundColor = UIColor.systemPinkColor()
    config.baseForegroundColor = UIColor.systemGreenColor()

    tapButton = UIButton.new()
    tapButton.configuration = config
    tapButton.addTarget_action_forControlEvents_(self, SEL('onTap:'),
                                                 touchUpInside)

    self.view.addSubview_(tapButton)
    # --- Layout
    tapButton.translatesAutoresizingMaskIntoConstraints = False
    NSLayoutConstraint.activateConstraints_([
      tapButton.centerXAnchor.constraintEqualToAnchor_(
        self.view.centerXAnchor),
      tapButton.centerYAnchor.constraintEqualToAnchor_(
        self.view.centerYAnchor),
      tapButton.widthAnchor.constraintEqualToAnchor_multiplier_(
        self.view.widthAnchor, 0.4),
      tapButton.heightAnchor.constraintEqualToAnchor_multiplier_(
        self.view.heightAnchor, 0.1),
    ])


class SecondViewController(UIViewController):

  @objc_method
  def onTap_(self, sender):
    navigationController = self.navigationController
    navigationController.popViewControllerAnimated_(True)

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    # --- Navigation
    self.navigationItem.title = 'SecondView'

    # --- View
    self.view.backgroundColor = UIColor.systemGreenColor()
    config = UIButtonConfiguration.tintedButtonConfiguration()
    config.title = 'Tap'
    config.baseBackgroundColor = UIColor.systemPinkColor()
    config.baseForegroundColor = UIColor.systemBlueColor()

    tapButton = UIButton.new()
    tapButton.configuration = config
    tapButton.addTarget_action_forControlEvents_(self, SEL('onTap:'),
                                                 touchUpInside)

    self.view.addSubview_(tapButton)
    # --- Layout
    tapButton.translatesAutoresizingMaskIntoConstraints = False
    NSLayoutConstraint.activateConstraints_([
      tapButton.centerXAnchor.constraintEqualToAnchor_(
        self.view.centerXAnchor),
      tapButton.centerYAnchor.constraintEqualToAnchor_(
        self.view.centerYAnchor),
      tapButton.widthAnchor.constraintEqualToAnchor_multiplier_(
        self.view.widthAnchor, 0.4),
      tapButton.heightAnchor.constraintEqualToAnchor_multiplier_(
        self.view.heightAnchor, 0.1),
    ])


# --- main
@onMainThread
def present_viewController(myVC: UIViewController):
  app = ObjCClass('UIApplication').sharedApplication
  window = app.keyWindow if app.keyWindow else app.windows[0]
  rootVC = window.rootViewController

  while _presentedVC := rootVC.presentedViewController:
    rootVC = _presentedVC

  myNC = RootNavigationController.alloc().initWithRootViewController_(myVC)

  presentVC = myNC

  # ref: [UIModalPresentationStyle | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uimodalpresentationstyle?language=objc)
  '''
  UIModalPresentationFullScreen = 0
  UIModalPresentationPageSheet = 1
  '''
  presentVC.setModalPresentationStyle_(1)

  rootVC.presentViewController_animated_completion_(presentVC, True, None)


if __name__ == "__main__":
  vc = FirstViewController.new()
  present_viewController(vc)

```

## delegate

### objc_util

### rubicon

## main Thread

## print é–¢ä¿‚

:::message
è¿½è¨˜äºˆå®šï¼ˆåˆ†å‰²ã™ã‚‹ã‹ã‚‚ï¼‰ã€‚
:::
