---
title: "„Äêprotocol„Äëobjc_util „Åã„Çârubicon-objc „Å∏ÁßªË°å„Äêdelegate„Äë"
emoji: "üì≤"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["Python", "iOS", "objectivec", "Pythonista3", "rubiconobjc"]
published: false
---
## objc_util „Åã„Çârubicon-objc „Å∏‰πó„ÇäÊèõ„Åà„Çã

ÂâçÂõû„ÅØ„ÄÅclassÂÆ£Ë®Ä„ÅÆÊñπÊ≥ï„Å´„Å§„ÅÑ„Å¶Êï¥ÁêÜ„Åó„Åæ„Åó„Åü„ÄÇ

@[card](https://zenn.dev/pometa/articles/7f70cc2fae9cb3)

rubicon-objc„ÅÆÊñπ„Åå„ÄÅPythonic„Å™classÂÆ£Ë®Ä„Åß„Åó„Åü„ÄÇ„Å§„Åæ„Çä„ÄÅobjc_util„ÅÆ`create_objc_class`„Å´‰æùÂ≠ò„Åó„ÅüÊõ∏„ÅçÊñπ„Åå„Åß„Åç„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ

‰ªäÂõû„ÅØ„ÄÅprotocolÔºàdelegateÔºâ„Çí‰∏≠ÂøÉ„Å´„ÄÅ„Ç≥„Éº„Éâ„ÅÆÊõ∏„ÅçÊèõ„Åà„ÅÆÊï¥ÁêÜ„Çí„Åó„Åæ„Åô„ÄÇ

## „Éó„É≠„Éà„Ç≥„É´„ÇíÂÆöÁæ©„Åó„ÄÅ„Éá„É™„Ç≤„Éº„Éà„É°„ÇΩ„ÉÉ„Éâ„ÇíÂëº„Å≥Âá∫„Åô

‰Ωø„ÅÜÂ†¥Èù¢„Å®„Åó„Å¶:

- ‰ªäÂõû‰ΩøÁî®„Åô„Çã„ÇÇ„ÅÆ
  - [UINavigationControllerDelegate | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uinavigationcontrollerdelegate?language=objc)

- Pythonista3„ÅÆdocs„Å´‰æã„Å®„Åó„Å¶„ÅÇ„Å£„Åü„ÇÇ„ÅÆ
  - [UIGestureRecognizerDelegate | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uigesturerecognizerdelegate?language=objc)
  - [UITableViewDataSource | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uitableviewdatasource?language=objc)

Apple Developer Documentation„Åß`Protocol`„Å®Ë°®Ë®ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„Å´‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ
`UITableViewDataSource`„ÅÆ„Çà„ÅÜ„Å´`Delegate`„ÅåÂêçÂâç„Å´ÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÇÇ„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åæ„Åö„ÅØ„ÄÅÔºàAppleÔºâÂÖ¨ÂºèDocumentation„ÅßË™ø„Åπ„Çã„Åì„Å®„ÅåÂ§ßÂàá„Åß„Åô„ÄÇ

### objc_util „ÅÆÂ†¥Âêà

class„ÅÆÂÆ£Ë®Ä„Å®ÂêåÊßò„Å´„ÄÅ[create_objc_class](https://omz-software.com/pythonista/docs-3.4/py3/ios/objc_util.html#objc_util.create_objc_class)„ÅßÂÆ£Ë®Ä„Çí„Åó„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ

@[card](https://omz-software.com/pythonista/docs-3.4/py3/ios/objc_util.html#objc_util.create_objc_class)

‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„ÅØ„ÄÅÈñâ„Åò„Çã„Éú„Çø„É≥„ÇíÂè≥ËÇ©„Å´ÊåÅ„Åü„Åõ„Åü[`UINavigationController`](https://developer.apple.com/documentation/uikit/uinavigationcontroller?language=objc)„ÇíÂÆüË£Ö„Åó„Åü‰æãÔºà‰∏ÄÈÉ®‰∏≠Áï•Ôºâ„Åß„Åô„ÄÇ
`ui`„É¢„Ç∏„É•„Éº„É´„ÅÆ[ui.NavigationView](https://omz-software.com/pythonista/docs-3.4/py3/ios/ui.html#ui.NavigationView)„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Çí„Ç§„É°„Éº„Ç∏„Åó„Å¶„ÅÑ„Åæ„Åô(`ui`„É¢„Ç∏„É•„Éº„É´„Çí‰Ωø„Çè„Åö„Å´„ÄÅPythonista3‰∏ä„ÅßÁã¨Ëá™„Å´UIKit„ÇíÂëº„Å≥Âá∫„ÅôÂ†¥Èù¢„Åß‰ΩøÁî®)„ÄÇ

„Åì„ÅÆ„Ç≥„Éº„Éâ„Åß„ÄÅ„Éó„É≠„Éà„Ç≥„É´ÂÆöÁæ©„Å®„Éá„É™„Ç≤„Éº„Éà„É°„ÇΩ„ÉÉ„Éâ„ÇíÂëº„Å≥Âá∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

:::message
ToDo: „Ç≠„É£„Éó„ÉÅ„É£„ÅÆGif„ÅãÈùôÊ≠¢Áîª„ÇíËºâ„Åõ„Å¶Ë£úË∂≥Ë™¨Êòé„Åô„Çã‰∫àÂÆö„ÄÇ
:::

```python:objc_util„ÅÆsample.py
UINavigationController = ObjCClass('UINavigationController')

class NavigationController:

  def __init__(self):
    self._navigationController: UINavigationController

  def _override_navigationController(self):
    # --- `UINavigationController` Methods
    def doneButtonTapped_(_self, _cmd, _sender):
      """ÔºàËá™Ë∫´„ÅÆÔºâ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÁµÇ‰∫Ü
      `NavigationController` „Åã„ÇâÁîü„ÇÑ„Åó„Åü`done_btn` „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥
      """
      this = ObjCInstance(_self)
      visibleViewController = this.visibleViewController()
      visibleViewController.dismissViewControllerAnimated_completion_(
        True, None)

    # --- `UINavigationController` set up
    _methods = [
      doneButtonTapped_,
    ]

    create_kwargs = {
      'name': '_nv',
      'superclass': UINavigationController,
      'methods': _methods,
    }
    _nv = create_objc_class(**create_kwargs)
    self._navigationController = _nv

  def create_navigationControllerDelegate(self):
    # --- `UINavigationControllerDelegate` Methods
    def navigationController_willShowViewController_animated_(
        _self, _cmd, _navigationController, _viewController, _animated):

      navigationController = ObjCInstance(_navigationController)
      viewController = ObjCInstance(_viewController)
      """
      Èï∑„ÅÑ„ÅÆ„Åß‰∏≠Áï•
      """
      done_btn = UIBarButtonItem.alloc(
      ).initWithBarButtonSystemItem_target_action_(0, navigationController,
                                                   sel('doneButtonTapped:'))
      visibleViewController = navigationController.visibleViewController()
      # --- navigationItem
      navigationItem = visibleViewController.navigationItem()
      navigationItem.rightBarButtonItem = done_btn

    # --- `UINavigationControllerDelegate` set up
    _methods = [
      navigationController_willShowViewController_animated_,
    ]
    _protocols = [
      'UINavigationControllerDelegate',
    ]

    create_kwargs = {
      'name': '_nvDelegate',
      'methods': _methods,
      'protocols': _protocols,
    }
    _nvDelegate = create_objc_class(**create_kwargs)
    return _nvDelegate.new()

  @on_main_thread
  def _init(self, vc: UIViewController):
    self._override_navigationController()
    _delegate = self.create_navigationControllerDelegate()
    nv = self._navigationController.alloc()
    nv.initWithRootViewController_(vc).autorelease()
    nv.setDelegate_(_delegate)
    return nv

  @classmethod
  def new(cls, vc: UIViewController) -> ObjCInstance:
    _cls = cls()
    return _cls._init(vc)
```

#### ÂÆüË°å„ÅÆÊµÅ„Çå

### rubicon-objc „ÅÆÂ†¥Âêà

## „É°„É¢

block„ÅÆ„Åì„Å®„ÅØ„ÄÅaudio„Åß„ÇÑ„Çã„ÅÆ„Åß„ÄÅdelegate„Åô„Çã„Åü„ÇÅ„Å´„ÄÅprotocol„ÇíÂëº„Å≥Âá∫„ÅôÊÑü„Åò„ÅßË™¨Êòé„Çí„Åó„Å¶„ÅÑ„Åè„ÄÇ

## code

```main.py
from rubicon.objc.api import ObjCClass, ObjCProtocol, objc_method
from rubicon.objc.runtime import SEL, send_super

import pdbr

ObjCClass.auto_rename = True

### --- onMainThread --- ###
from ctypes import byref, cast, Structure
import functools
from rubicon.objc.api import Block, ObjCClass, ObjCInstance
from rubicon.objc.runtime import libobjc, objc_block, objc_id

NSThread = ObjCClass('NSThread')


class struct_dispatch_queue_s(Structure):
  pass  # No _fields_, because this is an opaque structure.


_dispatch_main_q = struct_dispatch_queue_s.in_dll(libobjc, '_dispatch_main_q')


def dispatch_get_main_queue():
  return ObjCInstance(cast(byref(_dispatch_main_q), objc_id))


libobjc.dispatch_async.restype = None
libobjc.dispatch_async.argtypes = [objc_id, objc_block]


def onMainThread(func):

  @functools.wraps(func)
  def wrapper(*args, **kwargs):
    if NSThread.isMainThread:
      func(*args, **kwargs)
    block = Block(functools.partial(func, *args, **kwargs), None)
    libobjc.dispatch_async(dispatch_get_main_queue(), block)

  return wrapper


### --- ###

# --- UINavigationController
UINavigationController = ObjCClass('UINavigationController')
UINavigationControllerDelegate = ObjCProtocol('UINavigationControllerDelegate')
UINavigationBarAppearance = ObjCClass('UINavigationBarAppearance')
UIBarButtonItem = ObjCClass('UIBarButtonItem')

# --- UIViewController
UIViewController = ObjCClass('UIViewController')
UIColor = ObjCClass('UIColor')
UIButtonConfiguration = ObjCClass('UIButtonConfiguration')
UIButton = ObjCClass('UIButton')

NSLayoutConstraint = ObjCClass('NSLayoutConstraint')
# ref: [UIRectEdge | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uirectedge?language=objc)
'''
UIRectEdgeNone = 0
'''
edgeNone = 0

# ref: [UIControlEvents | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uicontrolevents?language=objc)
'''
UIControlEventTouchUpInside = 1 <<  6
'''
touchUpInside = 1 << 6

# ref: [UIBarButtonSystemItem | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uibarbuttonsystemitem?language=objc)
'''
UIBarButtonSystemItemDone
'''
done = 0


# --- NavigationController
class RootNavigationController(UINavigationController,
                               protocols=[UINavigationControllerDelegate]):

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    appearance = UINavigationBarAppearance.new()
    appearance.configureWithDefaultBackground()

    navigationBar = self.navigationBar
    navigationBar.standardAppearance = appearance
    navigationBar.scrollEdgeAppearance = appearance
    navigationBar.compactAppearance = appearance
    navigationBar.compactScrollEdgeAppearance = appearance

    self.delegate = self

  @objc_method
  def doneButtonTapped_(self, sender):
    visibleViewController = self.visibleViewController
    visibleViewController.dismissViewControllerAnimated_completion_(True, None)

  @objc_method
  def navigationController_willShowViewController_animated_(
      self, navigationController, viewController, animated: bool):
    viewController.setEdgesForExtendedLayout_(edgeNone)
    doneButton = UIBarButtonItem.alloc(
    ).initWithBarButtonSystemItem_target_action_(done, navigationController,
                                                 SEL('doneButtonTapped:'))
    visibleViewController = navigationController.visibleViewController

    navigationItem = visibleViewController.navigationItem
    navigationItem.rightBarButtonItem = doneButton


# --- ViewController
class FirstViewController(UIViewController):

  @objc_method
  def onTap_(self, sender):
    svc = SecondViewController.new()
    navigationController = self.navigationController
    navigationController.pushViewController_animated_(svc, True)

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    # --- Navigation
    self.navigationItem.title = 'FirstView'

    # --- View
    self.view.backgroundColor = UIColor.systemBlueColor()
    config = UIButtonConfiguration.tintedButtonConfiguration()
    config.title = 'Tap'
    config.baseBackgroundColor = UIColor.systemPinkColor()
    config.baseForegroundColor = UIColor.systemGreenColor()

    tapButton = UIButton.new()
    tapButton.configuration = config
    tapButton.addTarget_action_forControlEvents_(self, SEL('onTap:'),
                                                 touchUpInside)

    self.view.addSubview_(tapButton)
    # --- Layout
    tapButton.translatesAutoresizingMaskIntoConstraints = False
    NSLayoutConstraint.activateConstraints_([
      tapButton.centerXAnchor.constraintEqualToAnchor_(
        self.view.centerXAnchor),
      tapButton.centerYAnchor.constraintEqualToAnchor_(
        self.view.centerYAnchor),
      tapButton.widthAnchor.constraintEqualToAnchor_multiplier_(
        self.view.widthAnchor, 0.4),
      tapButton.heightAnchor.constraintEqualToAnchor_multiplier_(
        self.view.heightAnchor, 0.1),
    ])


class SecondViewController(UIViewController):

  @objc_method
  def onTap_(self, sender):
    navigationController = self.navigationController
    navigationController.popViewControllerAnimated_(True)

  @objc_method
  def viewDidLoad(self):
    send_super(__class__, self, 'viewDidLoad')
    # --- Navigation
    self.navigationItem.title = 'SecondView'

    # --- View
    self.view.backgroundColor = UIColor.systemGreenColor()
    config = UIButtonConfiguration.tintedButtonConfiguration()
    config.title = 'Tap'
    config.baseBackgroundColor = UIColor.systemPinkColor()
    config.baseForegroundColor = UIColor.systemBlueColor()

    tapButton = UIButton.new()
    tapButton.configuration = config
    tapButton.addTarget_action_forControlEvents_(self, SEL('onTap:'),
                                                 touchUpInside)

    self.view.addSubview_(tapButton)
    # --- Layout
    tapButton.translatesAutoresizingMaskIntoConstraints = False
    NSLayoutConstraint.activateConstraints_([
      tapButton.centerXAnchor.constraintEqualToAnchor_(
        self.view.centerXAnchor),
      tapButton.centerYAnchor.constraintEqualToAnchor_(
        self.view.centerYAnchor),
      tapButton.widthAnchor.constraintEqualToAnchor_multiplier_(
        self.view.widthAnchor, 0.4),
      tapButton.heightAnchor.constraintEqualToAnchor_multiplier_(
        self.view.heightAnchor, 0.1),
    ])


# --- main
@onMainThread
def present_viewController(myVC: UIViewController):
  app = ObjCClass('UIApplication').sharedApplication
  window = app.keyWindow if app.keyWindow else app.windows[0]
  rootVC = window.rootViewController

  while _presentedVC := rootVC.presentedViewController:
    rootVC = _presentedVC

  myNC = RootNavigationController.alloc().initWithRootViewController_(myVC)

  presentVC = myNC

  # ref: [UIModalPresentationStyle | Apple Developer Documentation](https://developer.apple.com/documentation/uikit/uimodalpresentationstyle?language=objc)
  '''
  UIModalPresentationFullScreen = 0
  UIModalPresentationPageSheet = 1
  '''
  presentVC.setModalPresentationStyle_(1)

  rootVC.presentViewController_animated_completion_(presentVC, True, None)


if __name__ == "__main__":
  vc = FirstViewController.new()
  present_viewController(vc)

```

## delegate

### objc_util

### rubicon

## main Thread

## print Èñ¢‰øÇ

:::message
ËøΩË®ò‰∫àÂÆöÔºàÂàÜÂâ≤„Åô„Çã„Åã„ÇÇÔºâ„ÄÇ
:::
